<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Monolith App</title>
    <style>
      /* =====================
       MONOLITH APP BASE CSS
       ===================== */
      :root {
        --bg: #0b0c0f;
        --panel: #12151a;
        --text: #e9eef5;
        --muted: #a6b0c3;
        --accent: #7cd2ff;
        --accent-2: #c299ff;
        --danger: #ff6b6b;
        --ok: #4cd964;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --radius: 16px;
      }
      [data-theme="light"] {
        --bg: #f6f7fb;
        --panel: #ffffff;
        --text: #0f1222;
        --muted: #4b5565;
        --accent: #006cbe;
        --accent-2: #6a32c9;
        --danger: #cc2b2b;
        --ok: #2c8b3f;
        --shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font:
          14px/1.6 system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Ubuntu,
          Cantarell,
          Noto Sans,
          Helvetica,
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
        background: linear-gradient(180deg, var(--bg), #0a0c10 60%);
        color: var(--text);
      }
      header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.4),
          rgba(0, 0, 0, 0)
        );
        backdrop-filter: blur(10px);
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: space-between;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        letter-spacing: 0.3px;
      }
      .brand .logo {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        box-shadow: var(--shadow);
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      button,
      .btn {
        border: 1px solid color-mix(in oklab, var(--text) 12%, transparent);
        background: color-mix(in oklab, var(--panel) 70%, transparent);
        color: var(--text);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      button:hover {
        border-color: color-mix(in oklab, var(--accent) 40%, transparent);
      }
      .layout {
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 16px;
        padding: 12px 16px 32px;
      }
      aside {
        background: color-mix(in oklab, var(--panel) 90%, transparent);
        border: 1px solid color-mix(in oklab, var(--text) 10%, transparent);
        border-radius: var(--radius);
        padding: 12px;
        box-shadow: var(--shadow);
        height: calc(100dvh - 96px);
        overflow: auto;
      }
      main {
        background: color-mix(in oklab, var(--panel) 92%, transparent);
        border: 1px solid color-mix(in oklab, var(--text) 10%, transparent);
        border-radius: var(--radius);
        padding: 0;
        box-shadow: var(--shadow);
        min-height: calc(100dvh - 96px);
        overflow: clip;
      }
      nav {
        display: grid;
        gap: 6px;
      }
      .nav-item {
        display: grid;
        grid-template-columns: 24px 1fr auto;
        gap: 8px;
        padding: 8px;
        border-radius: 10px;
        align-items: center;
        cursor: pointer;
      }
      .nav-item:hover {
        background: color-mix(in oklab, var(--panel) 70%, transparent);
      }
      .nav-item.active {
        outline: 2px solid color-mix(in oklab, var(--accent) 55%, transparent);
      }
      .pill {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 999px;
        background: color-mix(in oklab, var(--accent) 30%, transparent);
        color: var(--text);
      }
      .search {
        width: 100%;
        padding: 8px 12px;
        background: transparent;
        color: var(--text);
        border-radius: 10px;
        border: 1px solid color-mix(in oklab, var(--text) 10%, transparent);
      }
      .section-title {
        font-weight: 700;
        color: var(--muted);
        margin: 10px 0 6px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 12px;
      }

      /* Main viewport */
      #viewport {
        display: grid;
        grid-template-rows: auto 1fr;
        height: 100%;
      }
      .view-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        border-bottom: 1px solid
          color-mix(in oklab, var(--text) 10%, transparent);
      }
      .view-body {
        padding: 16px;
        overflow: auto;
      }

      /* Feature-specific CSS goes below. Add only within FEATURES_CSS_HERE marker. */
      /* === FEATURES_CSS_HERE === */
      /* Scratchpad feature */
      .scratchpad {
        display: grid;
        gap: 12px;
      }
      .scratchpad textarea {
        width: 100%;
        height: 40dvh;
        border-radius: 12px;
        padding: 12px;
        background: #00000020;
        color: var(--text);
        border: 1px solid color-mix(in oklab, var(--text) 15%, transparent);
      }
      .muted {
        color: var(--muted);
      }

      /* Pro feature */
      .kv {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 8px;
        align-items: center;
      }
      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid color-mix(in oklab, var(--text) 12%, transparent);
        font-size: 12px;
      }
      .paywall {
        background: #00000020;
        border: 1px dashed color-mix(in oklab, var(--text) 20%, transparent);
        padding: 20px;
        border-radius: 12px;
      }

      /* Test runner */
      .test-pass {
        color: var(--ok);
      }
      .test-fail {
        color: var(--danger);
      }
      .test-log {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        white-space: pre-wrap;
        background: #00000020;
        padding: 10px;
        border-radius: 10px;
      }

      /* Rock Paper Scissors */
      .rps-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      .rps-btn {
        font-size: 40px;
        padding: 20px;
        width: 100px;
        height: 100px;
        border-radius: 50%;
      }
      .rps-result {
        text-align: center;
        margin: 20px 0;
        font-weight: bold;
      }
      .rps-scores {
        text-align: center;
        color: var(--muted);
      }

      /* Password Generator */
      .passgen-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 500px;
        margin: 0 auto;
      }
      .passgen-display {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .passgen-output {
        flex-grow: 1;
        padding: 12px;
        background: #00000030;
        border-radius: 10px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 16px;
        border: 1px solid transparent;
      }
      .passgen-output.empty {
        color: var(--muted);
      }
      .passgen-options {
        display: grid;
        gap: 12px;
      }
      .passgen-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .passgen-option label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }
      .passgen-slider {
        flex-grow: 1;
        accent-color: var(--accent);
      }
      .passgen-length {
        font-weight: bold;
      }
      .passgen-generate-btn {
        padding: 12px;
        font-size: 16px;
        background: var(--accent);
        color: var(--bg);
        border: none;
        font-weight: bold;
      }
      .passgen-generate-btn:hover {
        opacity: 0.9;
      }

      /* Code Snippets */
      .snippets-container {
        display: grid;
        gap: 16px;
      }
      .snippets-header {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .snippets-search {
        flex: 1;
        min-width: 200px;
      }
      .snippets-grid {
        display: grid;
        gap: 12px;
      }
      .snippet-card {
        background: color-mix(in oklab, var(--panel) 80%, transparent);
        border: 1px solid color-mix(in oklab, var(--text) 12%, transparent);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.2s ease;
      }
      .snippet-card:hover {
        border-color: color-mix(in oklab, var(--accent) 40%, transparent);
      }
      .snippet-header {
        padding: 12px 16px;
        border-bottom: 1px solid
          color-mix(in oklab, var(--text) 8%, transparent);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .snippet-title {
        font-weight: 600;
      }
      .snippet-lang {
        background: color-mix(in oklab, var(--accent) 20%, transparent);
        color: var(--accent);
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
      }
      .snippet-actions {
        display: flex;
        gap: 6px;
      }
      .snippet-actions button {
        padding: 4px 8px;
        font-size: 12px;
        background: transparent;
        border: 1px solid color-mix(in oklab, var(--text) 15%, transparent);
      }
      .snippet-code {
        position: relative;
        background: #00000030;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 13px;
        line-height: 1.4;
        padding: 16px;
        overflow-x: auto;
        max-height: 200px;
        overflow-y: auto;
        white-space: pre;
      }
      .snippet-empty {
        text-align: center;
        color: var(--muted);
        padding: 40px 20px;
      }
      .snippet-form {
        background: color-mix(in oklab, var(--panel) 85%, transparent);
        border: 1px solid color-mix(in oklab, var(--text) 12%, transparent);
        border-radius: 12px;
        padding: 16px;
        display: grid;
        gap: 12px;
      }
      .snippet-form input,
      .snippet-form select,
      .snippet-form textarea {
        padding: 8px 12px;
        background: color-mix(in oklab, var(--panel) 60%, transparent);
        color: var(--text);
        border: 1px solid color-mix(in oklab, var(--text) 15%, transparent);
        border-radius: 8px;
        font-family: inherit;
      }
      .snippet-form textarea {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        height: 120px;
        resize: vertical;
      }
      .snippet-form-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        align-items: end;
      }
      .snippet-form-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      /* Pomodoro Timer */
      .pomodoro-container {
        max-width: 600px;
        margin: 0 auto;
        display: grid;
        gap: 24px;
      }
      .pomodoro-timer-circle {
        width: 280px;
        height: 280px;
        margin: 0 auto;
        position: relative;
        background: radial-gradient(
          circle,
          color-mix(in oklab, var(--panel) 95%, transparent),
          color-mix(in oklab, var(--panel) 80%, transparent)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.2),
          inset 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .pomodoro-timer-svg {
        position: absolute;
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
      }
      .pomodoro-timer-svg circle {
        fill: none;
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease;
      }
      .pomodoro-timer-bg {
        stroke: color-mix(in oklab, var(--text) 10%, transparent);
      }
      .pomodoro-timer-progress {
        stroke: var(--accent);
      }
      .pomodoro-timer-progress.break {
        stroke: var(--ok);
      }
      .pomodoro-timer-display {
        text-align: center;
        z-index: 1;
      }
      .pomodoro-time {
        font-size: 48px;
        font-weight: 300;
        letter-spacing: 2px;
        font-variant-numeric: tabular-nums;
      }
      .pomodoro-phase {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 8px;
        color: var(--muted);
      }
      .pomodoro-controls {
        display: flex;
        gap: 12px;
        justify-content: center;
      }
      .pomodoro-btn-primary {
        padding: 12px 24px;
        font-size: 16px;
        font-weight: 600;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: white;
        border: none;
      }
      .pomodoro-btn-primary:hover {
        opacity: 0.9;
      }
      .pomodoro-btn-primary.break {
        background: linear-gradient(135deg, var(--ok), #3fb555);
      }
      .pomodoro-settings {
        display: grid;
        gap: 16px;
        padding: 20px;
        background: color-mix(in oklab, var(--panel) 85%, transparent);
        border-radius: 12px;
      }
      .pomodoro-setting-row {
        display: grid;
        grid-template-columns: 1fr 80px 40px;
        gap: 12px;
        align-items: center;
      }
      .pomodoro-setting-label {
        font-weight: 500;
      }
      .pomodoro-setting-value {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }
      .pomodoro-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        padding: 16px;
        background: color-mix(in oklab, var(--panel) 80%, transparent);
        border-radius: 12px;
      }
      .pomodoro-stat {
        text-align: center;
      }
      .pomodoro-stat-value {
        font-size: 24px;
        font-weight: 600;
        color: var(--accent);
      }
      .pomodoro-stat-label {
        font-size: 12px;
        color: var(--muted);
        margin-top: 4px;
      }
      .pomodoro-task-input {
        width: 100%;
        padding: 12px;
        background: color-mix(in oklab, var(--panel) 60%, transparent);
        color: var(--text);
        border: 1px solid color-mix(in oklab, var(--text) 15%, transparent);
        border-radius: 8px;
        font-size: 14px;
      }
      .pomodoro-history {
        max-height: 200px;
        overflow-y: auto;
        padding: 12px;
        background: color-mix(in oklab, var(--panel) 75%, transparent);
        border-radius: 8px;
      }
      .pomodoro-history-item {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        padding: 8px 0;
        border-bottom: 1px solid
          color-mix(in oklab, var(--text) 5%, transparent);
      }
      .pomodoro-history-item:last-child {
        border-bottom: none;
      }
      .pomodoro-history-task {
        font-weight: 500;
      }
      .pomodoro-history-time {
        font-size: 12px;
        color: var(--muted);
      }
      .pomodoro-notification {
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 16px 24px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: white;
        border-radius: 12px;
        box-shadow: var(--shadow);
        animation:
          slideIn 0.3s ease,
          slideOut 0.3s ease 2.7s forwards;
        z-index: 100;
      }
      @keyframes slideIn {
        from {
          transform: translateX(400px);
        }
        to {
          transform: translateX(0);
        }
      }
      @keyframes slideOut {
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>Monolith App</div>
      </div>
      <div class="toolbar">
        <button id="themeToggle" title="Toggle theme">üåì Theme</button>
        <button id="exportBtn" title="Export app state">‚á™ Export</button>
        <label class="btn" title="Import app state"
          ><input
            id="importFile"
            type="file"
            accept="application/json"
            style="display: none"
          />‚á© Import</label
        >
      </div>
    </header>
    <div class="layout">
      <aside>
        <input
          id="globalSearch"
          class="search"
          placeholder="Search features‚Ä¶"
        />
        <div class="section-title">Features</div>
        <nav id="nav"></nav>
        <div class="section-title">About</div>
        <div style="font-size: 12px; color: var(--muted)">
          This is a single-file, no-build web app. Everything lives here. Add
          features via the registry API in the JS section.
        </div>
      </aside>
      <main>
        <div id="viewport">
          <div id="viewHeader" class="view-header"></div>
          <div id="viewBody" class="view-body"></div>
        </div>
      </main>
    </div>

    <script type="module">
      "use strict";
      /* =====================
       MONOLITH APP CORE
       - No build, single file, runs in modern browsers.
       - Extension points marked with FEATURES_JS_HERE and FEATURES_CSS_HERE.
       - Add features by calling registerFeature({ id, name, icon, keywords, mount(ctx) {...} })
       - Keep IDs unique (suggest kebab-case). Use ctx.store/ctx.bus/ctx.persist.
       ===================== */

      // --- tiny util helpers
      const $ = (sel, el = document) => el.querySelector(sel);
      const $$ = (sel, el = document) => Array.from(el.querySelectorAll(sel));
      const uid = (p = "id") =>
        `${p}-${Math.random().toString(36).slice(2, 9)}`;

      // --- persistence
      const PERSIST_KEY = "monolith_state_v1";
      const loadJSON = (k, d) => {
        try {
          return JSON.parse(localStorage.getItem(k)) ?? d;
        } catch {
          return d;
        }
      };
      const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

      // --- event bus (pub/sub)
      const bus = (() => {
        const map = new Map();
        return {
          on(type, fn) {
            if (!map.has(type)) map.set(type, new Set());
            map.get(type).add(fn);
            return () => map.get(type).delete(fn);
          },
          emit(type, data) {
            (map.get(type) ?? []).forEach((fn) => fn(data));
          },
        };
      })();

      // --- simple global store (immutable-ish)
      const initialState = loadJSON(PERSIST_KEY, {
        app: {
          theme: matchMedia("(prefers-color-scheme: light)").matches
            ? "light"
            : "dark",
          version: "0.6.0",
        },
        features: {}, // feature-local states by id
        registry: [], // list of features
      });

      const store = (() => {
        let state = initialState;
        const subs = new Set();
        function get() {
          return state;
        }
        function set(next) {
          state = structuredClone(next);
          saveJSON(PERSIST_KEY, state);
          subs.forEach((fn) => fn(state));
          bus.emit("state:changed", state);
        }
        function patch(path, value) {
          const next = structuredClone(state);
          // tiny dot-path set
          const parts = path.split(".");
          let cur = next;
          for (let i = 0; i < parts.length - 1; i++) {
            cur = cur[parts[i]] ?? (cur[parts[i]] = {});
          }
          cur[parts.at(-1)] = value;
          set(next);
        }
        function sub(fn) {
          subs.add(fn);
          return () => subs.delete(fn);
        }
        return { get, set, patch, sub };
      })();

      // sanitize any persisted registry duplicates from previous sessions
      {
        const current = store.get();
        if (!Array.isArray(current.registry)) {
          current.registry = [];
          store.set(current);
        } else {
          const seen = new Set();
          let changed = false;
          const deduped = current.registry.filter((entry) => {
            if (!entry || !entry.id) {
              changed = true;
              return false;
            }
            if (seen.has(entry.id)) {
              changed = true;
              return false;
            }
            seen.add(entry.id);
            return true;
          });
          if (changed) {
            current.registry = deduped;
            store.set(current);
          }
        }
      }

      // apply theme
      document.documentElement.setAttribute(
        "data-theme",
        store.get().app.theme,
      );

      // --- license utilities (offline, no wallet/MetaMask; CDN ESM allowed but not required)
      const License = (() => {
        const b64enc = (s) =>
          btoa(String.fromCharCode(...new TextEncoder().encode(s)));
        const b64dec = (b) =>
          new TextDecoder().decode(
            Uint8Array.from(atob(b), (c) => c.charCodeAt(0)),
          );
        const sum = (s) => {
          let t = 0;
          for (let i = 0; i < s.length; i++) {
            t = (t + s.charCodeAt(i)) % 100000;
          }
          return t.toString(36);
        };
        function encode(obj) {
          const body = b64enc(JSON.stringify(obj));
          return `MONO1.${sum(body)}.${body}`;
        }
        function decode(str) {
          try {
            const [tag, chk, body] = String(str || "").split(".");
            if (tag !== "MONO1") return null;
            if (sum(body) !== chk) return null;
            return JSON.parse(b64dec(body));
          } catch {
            return null;
          }
        }
        function isActive(lic) {
          if (!lic) return false;
          if (lic.exp && new Date(lic.exp) < new Date()) return false;
          return true;
        }
        return { encode, decode, isActive };
      })();

      function proStatus() {
        const licStr = store.get().features?.pro?.license ?? null;
        const lic = License.decode(licStr);
        return {
          active: License.isActive(lic),
          license: lic,
          licenseStr: licStr,
        };
      }

      // expose internals for tests
      window.__monolith = {
        store,
        bus,
        License,
        proStatus,
        canAccess: (def) => !def?.requiresPro || proStatus().active,
      };

      // --- feature registry & router
      const registry = new Map();
      function registerFeature(def) {
        if (!def || !def.id) throw new Error("Feature requires an id");
        if (registry.has(def.id))
          throw new Error("Feature id already exists: " + def.id);
        const wrapped = {
          keywords: [],
          icon: "üß©",
          requiresPro: false,
          ...def,
        };
        registry.set(def.id, wrapped);
        // add to store registry list for navigation order
        const s = store.get();
        const existingIdx = Array.isArray(s.registry)
          ? s.registry.findIndex((x) => x && x.id === def.id)
          : -1;
        if (existingIdx === -1) {
          s.registry.push({ id: def.id, name: def.name });
        } else {
          // keep latest name in case it changed
          s.registry[existingIdx].name = def.name;
        }
        store.set(s);
        wrapped.onRegister?.(ctx(def.id));
        renderNav();
      }

      function ctx(id) {
        return {
          id,
          elHeader: $("#viewHeader"),
          elBody: $("#viewBody"),
          store,
          bus,
          get state() {
            return store.get().features[id] ?? (store.get().features[id] = {});
          },
          setState(partial) {
            const cur = store.get();
            cur.features[id] = { ...(cur.features[id] || {}), ...partial };
            store.set(cur);
          },
          persist(key, value) {
            const cur = store.get();
            const base = cur.features[id] ?? {};
            base[key] = value;
            cur.features[id] = base;
            store.set(cur);
          },
        };
      }

      function currentRoute() {
        return (location.hash.replace(/^#\/?/, "") || "").split("/");
      }
      function go(id) {
        location.hash = `#/${id}`;
      }

      window.addEventListener("hashchange", () => renderRoute());

      function renderNav(filter = "") {
        const nav = $("#nav");
        nav.innerHTML = "";
        const items = store
          .get()
          .registry.map(({ id, name }) => ({ id, name, def: registry.get(id) }))
          .filter((x) =>
            (x.name + x.id + (x.def?.keywords || []).join(" "))
              .toLowerCase()
              .includes(filter.toLowerCase()),
          );
        for (const it of items) {
          const div = document.createElement("div");
          div.className = "nav-item";
          const pill = it.def?.requiresPro
            ? '<span class="pill">PRO</span>'
            : `<div class="pill">${it.id}</div>`;
          div.innerHTML = `<div>${it.def?.icon ?? "üß©"}</div><div>${it.name}</div><div>${pill}</div>`;
          div.onclick = () => go(it.id);
          if (currentRoute()[0] === it.id) div.classList.add("active");
          nav.appendChild(div);
        }
      }

      function renderRoute() {
        const [featureId] = currentRoute();
        const f = registry.get(featureId);
        const header = $("#viewHeader");
        const body = $("#viewBody");
        header.innerHTML = "";
        body.innerHTML = "";
        if (!f) {
          header.innerHTML = `<div style="font-weight:700">Welcome</div><div class="muted">Monolith v${store.get().app.version}</div>`;
          body.innerHTML = `<p>This is a single-file app. Pick a feature on the left.</p>`;
          return;
        }
        const gated = f.requiresPro && !proStatus().active;
        header.innerHTML = `<div style="font-weight:700">${f.icon} ${f.name}</div><div class="muted">#${f.id}${gated ? " ‚Ä¢ Locked" : ""}</div>`;
        if (gated) {
          const div = document.createElement("div");
          div.className = "paywall";
          div.innerHTML = `
          <h3>üîí This feature requires <span class="badge">Monolith Pro</span></h3>
          <p>Activate Pro to unlock <b>${f.name}</b> and other premium features.</p>
          <button id="goProBtn">Activate Pro</button>
        `;
          body.appendChild(div);
          $("#goProBtn").onclick = () => go("pro");
        } else {
          try {
            f.mount(ctx(f.id));
          } catch (err) {
            const pre = document.createElement("pre");
            pre.textContent = String(err.stack || err);
            pre.style.color = "var(--danger)";
            body.appendChild(pre);
          }
        }
        renderNav($("#globalSearch").value);
      }

      // --- global UI controls
      $("#themeToggle").onclick = () => {
        const cur = store.get();
        cur.app.theme = cur.app.theme === "light" ? "dark" : "light";
        store.set(cur);
        document.documentElement.setAttribute("data-theme", cur.app.theme);
      };

      $("#exportBtn").onclick = () => {
        const data = JSON.stringify(store.get(), null, 2);
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement("a"), {
          href: url,
          download: "monolith_state.json",
        });
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      };

      $("#importFile").addEventListener("change", (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const next = JSON.parse(reader.result);
            store.set(next);
            renderNav($("#globalSearch").value);
            renderRoute();
          } catch (err) {
            alert("Invalid JSON");
          }
        };
        reader.readAsText(file);
        e.target.value = "";
      });

      $("#globalSearch").addEventListener("input", (e) =>
        renderNav(e.target.value),
      );

      store.sub(() => {
        document.documentElement.setAttribute(
          "data-theme",
          store.get().app.theme,
        );
      });

      // === FEATURES_JS_HERE ===
      // Example Feature: Scratchpad (baseline, easy to extend)
      registerFeature({
        id: "scratchpad",
        name: "Scratchpad",
        icon: "üìù",
        keywords: ["notes", "text", "editor"],
        mount(ctx) {
          const state = ctx.state;
          const wrapper = document.createElement("div");
          wrapper.className = "scratchpad";
          const tools = document.createElement("div");
          const ta = document.createElement("textarea");
          ta.placeholder = "Type notes here‚Ä¶";
          ta.value = state.text ?? "";
          ta.addEventListener("input", () => ctx.persist("text", ta.value));
          const info = document.createElement("div");
          info.className = "muted";
          const count = () =>
            (info.textContent = `${ta.value.length} chars ‚Ä¢ ${ta.value.split(/\s+/).filter(Boolean).length} words`);
          ta.addEventListener("input", count);
          count();

          const exportBtn = Object.assign(document.createElement("button"), {
            textContent: "Export to file",
          });
          exportBtn.onclick = () => {
            const blob = new Blob([ta.value], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = Object.assign(document.createElement("a"), {
              href: url,
              download: "scratchpad.txt",
            });
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          };

          const clearBtn = Object.assign(document.createElement("button"), {
            textContent: "Clear",
          });
          clearBtn.onclick = () => {
            if (confirm("Clear scratchpad?")) {
              ta.value = "";
              ta.dispatchEvent(new Event("input"));
            }
          };

          tools.append(exportBtn, clearBtn);
          wrapper.append(tools, ta, info);
          ctx.elBody.appendChild(wrapper);
        },
      });

      // Example Feature: Changelog (for LLMs to update)
      registerFeature({
        id: "changelog",
        name: "Changelog",
        icon: "üìú",
        keywords: ["history", "log"],
        mount(ctx) {
          const el = document.createElement("div");
          el.innerHTML = `
      <h3>Project Changelog</h3>
      <ul id="changelog-list" style="padding-left:20px">
        <li><b>v0.6.0</b> ‚Äì Added Pomodoro Timer with visual progress, sound notifications, session tracking, and productivity statistics. --Claude Opus</li>
        <li><b>v0.5.0</b> ‚Äì Added Code Snippet Manager with syntax highlighting, search, and language categorization for developers. --Claude Sonnet</li>
        <li><b>v0.4.0</b> ‚Äì Added a secure Password Generator with length/complexity options. --Gemini</li>
        <li><b>v0.3.0</b> ‚Äì Added Rock Paper Scissors game for fun. --Grok</li>
        <li><b>v0.2.0</b> ‚Äì Added offline <i>Pro</i> licensing (no MetaMask), Pro gating for features, and a Test Runner. Nav shows PRO-locked items. --GPT-5</li>
        <li><b>v0.1.0</b> ‚Äì Seeded project with core, theme toggle, state export/import, Scratchpad, and this Changelog.</li>
      </ul>
      <p class="muted">Future contributors: append entries above, newest first. Keep it short.</p>
    `;
          ctx.elBody.appendChild(el);
        },
      });

      // New Feature: Pro (licensing & paywall, offline)
      registerFeature({
        id: "pro",
        name: "Pro",
        icon: "üíé",
        keywords: ["license", "premium", "monetize"],
        mount(ctx) {
          const s = ctx.state;
          const status = proStatus();
          const root = document.createElement("div");
          root.innerHTML = `
      <div class="kv"><div>Status</div><div>${status.active ? '<span class="badge">Active</span>' : '<span class="badge">Free</span>'}</div></div>
      <div class="kv"><div>Plan</div><div>${status.license?.plan ?? "-"}</div></div>
      <div class="kv"><div>Owner</div><div>${status.license?.name ?? "-"}</div></div>
      <div class="kv"><div>Expires</div><div>${status.license?.exp ?? "‚Äî"}</div></div>
      <hr/>
      <h4>Activate with License</h4>
      <div class="kv"><div>License</div><div><input id="licInput" class="search" placeholder="Paste license blob here" /></div></div>
      <div class="kv"><div></div><div><button id="applyLic">Activate</button> <button id="clearLic">Remove</button> <button id="exportLic">Export</button></div></div>
      <hr/>
      <h4>Redeem Coupon</h4>
      <div class="kv"><div>Your name</div><div><input id="nameInput" class="search" placeholder="Jane Developer" value="${s.name || ""}"></div></div>
      <div class="kv"><div>Coupon</div><div><input id="couponInput" class="search" placeholder="FREE-TRIAL-7 or PRO-LIFETIME or PRO-ANNUAL"></div></div>
      <div class="kv"><div></div><div><button id="redeemBtn">Redeem</button></div></div>
      <p class="muted">Coupons are local-only and for demo. Licenses are encoded JSON with checksum; no network required.</p>
    `;
          ctx.elBody.appendChild(root);

          const $id = (x) => root.querySelector("#" + x);
          const writeLic = (licObj) => {
            const blob = License.encode(licObj);
            const cur = ctx.store.get();
            cur.features.pro = { ...(cur.features.pro || {}), license: blob };
            ctx.store.set(cur);
            ctx.setState({}); // trigger re-render on revisit
            alert("License activated.");
          };

          $id("applyLic").onclick = () => {
            const str = $id("licInput").value.trim();
            const obj = License.decode(str);
            if (!obj) {
              alert("Invalid license");
              return;
            }
            writeLic(obj);
          };
          $id("clearLic").onclick = () => {
            const cur = ctx.store.get();
            if (cur.features.pro) delete cur.features.pro.license;
            ctx.store.set(cur);
            alert("License removed.");
          };
          $id("exportLic").onclick = () => {
            const licStr = ctx.store.get().features?.pro?.license;
            if (!licStr) {
              alert("No license to export");
              return;
            }
            const blob = new Blob([licStr], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = Object.assign(document.createElement("a"), {
              href: url,
              download: "monolith.license.txt",
            });
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          };
          $id("redeemBtn").onclick = () => {
            const name = $id("nameInput").value.trim() || "Monolith User";
            const code = ($id("couponInput").value || "").trim().toUpperCase();
            const now = new Date();
            let plan,
              exp = null;
            if (code === "FREE-TRIAL-7") {
              plan = "trial";
              exp = new Date(now.getTime() + 7 * 24 * 3600e3).toISOString();
            } else if (code === "PRO-LIFETIME") {
              plan = "lifetime";
              exp = null;
            } else if (code === "PRO-ANNUAL") {
              plan = "annual";
              exp = new Date(now.getTime() + 365 * 24 * 3600e3).toISOString();
            } else {
              alert("Unknown coupon");
              return;
            }
            writeLic({ ver: 1, name, plan, issued: now.toISOString(), exp });
          };
        },
      });

      // Demo Feature (Pro-locked)
      registerFeature({
        id: "pro-demo",
        name: "Pro Demo",
        icon: "üöÄ",
        requiresPro: true,
        keywords: ["premium", "demo"],
        mount(ctx) {
          const box = document.createElement("div");
          box.innerHTML = `<p>Welcome to <b>Pro</b>! Here is a tiny bonus: <i>Focus Mode</i>.</p>`;
          const btn = Object.assign(document.createElement("button"), {
            textContent: "Toggle Focus Mode",
          });
          btn.onclick = () => document.body.classList.toggle("focus");
          const style = document.createElement("style");
          style.textContent = `body.focus aside{ display:none } body.focus .layout{ grid-template-columns: 1fr }`;
          ctx.elBody.appendChild(style);
          ctx.elBody.appendChild(box);
          ctx.elBody.appendChild(btn);
        },
      });

      // Test Runner Feature
      registerFeature({
        id: "tests",
        name: "Tests",
        icon: "üß™",
        keywords: ["qa", "spec"],
        mount(ctx) {
          const out = document.createElement("div");
          const log = (html) => {
            const p = document.createElement("div");
            p.innerHTML = html;
            out.appendChild(p);
          };
          const results = [];
          function test(name, fn) {
            try {
              fn();
              results.push({ name, ok: true });
              log(`<span class="test-pass">‚úî</span> ${name}`);
            } catch (e) {
              results.push({ name, ok: false, e });
              log(
                `<span class="test-fail">‚úñ</span> ${name}<div class="test-log">${String(e)}</div>`,
              );
            }
          }
          function assert(cond, msg) {
            if (!cond) throw new Error(msg || "assertion failed");
          }

          // --- Test cases ---
          test("License roundtrip enc/dec", () => {
            const obj = {
              ver: 1,
              name: "T",
              plan: "trial",
              issued: "2020-01-01T00:00:00.000Z",
              exp: "2099-01-01T00:00:00.000Z",
            };
            const blob = License.encode(obj);
            const back = License.decode(blob);
            assert(
              back && back.name === "T" && back.plan === "trial",
              "roundtrip mismatch",
            );
          });
          test("License tamper detection", () => {
            const obj = {
              ver: 1,
              name: "X",
              plan: "lifetime",
              issued: "2020-01-01T00:00:00.000Z",
              exp: null,
            };
            let blob = License.encode(obj);
            blob = blob.replace("X", "Y");
            const back = License.decode(blob);
            assert(back === null, "tamper not detected");
          });
          test("isActive respects expiry", () => {
            const past = {
              ver: 1,
              name: "A",
              plan: "trial",
              issued: "2020-01-01T00:00:00.000Z",
              exp: "2000-01-01T00:00:00.000Z",
            };
            const future = {
              ver: 1,
              name: "B",
              plan: "trial",
              issued: "2020-01-01T00:00:00.000Z",
              exp: "2099-01-01T00:00:00.000Z",
            };
            assert(License.isActive(past) === false, "past should be inactive");
            assert(
              License.isActive(future) === true,
              "future should be active",
            );
          });
          test("canAccess checks PRO gating", () => {
            const freeDef = { requiresPro: false };
            const proDef = { requiresPro: true };
            const was = ctx.store.get();
            // ensure no license
            const cur = ctx.store.get();
            cur.features.pro = { license: null };
            ctx.store.set(cur);
            assert(
              window.__monolith.canAccess(freeDef) === true,
              "free should be accessible",
            );
            assert(
              window.__monolith.canAccess(proDef) === false,
              "pro should be locked",
            );
          });

          ctx.elBody.appendChild(out);
        },
      });

      // Rock Paper Scissors Game
      registerFeature({
        id: "rps",
        name: "Rock Paper Scissors",
        icon: "‚úä",
        keywords: ["game", "fun", "rps"],
        mount(ctx) {
          const choices = ["‚úä", "‚úã", "‚úåÔ∏è"];
          const getComputerChoice = () =>
            choices[Math.floor(Math.random() * 3)];
          const determineWinner = (user, comp) => {
            if (user === comp) return "Tie";
            if (
              (user === "‚úä" && comp === "‚úåÔ∏è") ||
              (user === "‚úã" && comp === "‚úä") ||
              (user === "‚úåÔ∏è" && comp === "‚úã")
            )
              return "Win";
            return "Lose";
          };

          const state = ctx.state;
          state.scores = state.scores || { wins: 0, losses: 0, ties: 0 };

          const wrapper = document.createElement("div");
          wrapper.className = "rps-game";

          const inst = document.createElement("p");
          inst.textContent = "Choose your move:";
          inst.style.textAlign = "center";

          const btnDiv = document.createElement("div");
          btnDiv.className = "rps-buttons";

          choices.forEach((ch) => {
            const btn = document.createElement("button");
            btn.className = "rps-btn";
            btn.textContent = ch;
            btn.onclick = () => {
              const compChoice = getComputerChoice();
              const result = determineWinner(ch, compChoice);
              resultEl.innerHTML = `You: ${ch} Computer: ${compChoice} - ${result}!`;
              state.scores[`${result.toLowerCase()}s`]++;
              ctx.setState({ scores: state.scores });
              updateScores();
            };
            btnDiv.appendChild(btn);
          });

          const resultEl = document.createElement("div");
          resultEl.className = "rps-result";

          const scoresEl = document.createElement("div");
          scoresEl.className = "rps-scores";
          const updateScores = () => {
            scoresEl.textContent = `Wins: ${state.scores.wins} Losses: ${state.scores.losses} Ties: ${state.scores.ties}`;
          };
          updateScores();

          wrapper.append(inst, btnDiv, resultEl, scoresEl);
          ctx.elBody.appendChild(wrapper);
        },
      });

      // Password Generator
      registerFeature({
        id: "password-generator",
        name: "Password Generator",
        icon: "üîê",
        keywords: ["security", "password", "generate", "tool"],
        mount(ctx) {
          const CHARSETS = {
            lower: "abcdefghijklmnopqrstuvwxyz",
            upper: "ABCDEFGHIJKLMNOPQRSTUVWXYZ",
            numbers: "0123456789",
            symbols: "!@#$%^&*()_+-=[]{}|;:,.<>?",
          };

          const state = {
            length: ctx.state.length ?? 16,
            includeUpper: ctx.state.includeUpper ?? true,
            includeNumbers: ctx.state.includeNumbers ?? true,
            includeSymbols: ctx.state.includeSymbols ?? true,
          };
          ctx.setState(state);

          const container = document.createElement("div");
          container.className = "passgen-container";

          container.innerHTML = `
      <div class="passgen-display">
        <div id="passOutput" class="passgen-output empty">Click Generate...</div>
        <button id="copyBtn">Copy</button>
      </div>
      <div class="passgen-options">
        <div class="passgen-option">
          <label for="lengthSlider">Length: <span id="lengthVal" class="passgen-length">${state.length}</span></label>
          <input type="range" id="lengthSlider" class="passgen-slider" min="8" max="64" value="${state.length}">
        </div>
        <div class="passgen-option">
          <label for="upperCheck"><input type="checkbox" id="upperCheck" ${state.includeUpper ? "checked" : ""}> Include Uppercase</label>
        </div>
        <div class="passgen-option">
          <label for="numCheck"><input type="checkbox" id="numCheck" ${state.includeNumbers ? "checked" : ""}> Include Numbers</label>
        </div>
        <div class="passgen-option">
          <label for="symCheck"><input type="checkbox" id="symCheck" ${state.includeSymbols ? "checked" : ""}> Include Symbols</label>
        </div>
      </div>
      <button id="generateBtn" class="passgen-generate-btn">Generate Password</button>
    `;

          ctx.elBody.appendChild(container);

          const $id = (id) => container.querySelector(`#${id}`);
          const passOutput = $id("passOutput");
          const copyBtn = $id("copyBtn");
          const lengthSlider = $id("lengthSlider");
          const lengthVal = $id("lengthVal");
          const upperCheck = $id("upperCheck");
          const numCheck = $id("numCheck");
          const symCheck = $id("symCheck");
          const generateBtn = $id("generateBtn");

          const generatePassword = () => {
            let charPool = CHARSETS.lower;
            let password = [
              CHARSETS.lower[Math.floor(Math.random() * CHARSETS.lower.length)],
            ];

            if (state.includeUpper) {
              charPool += CHARSETS.upper;
              password.push(
                CHARSETS.upper[
                  Math.floor(Math.random() * CHARSETS.upper.length)
                ],
              );
            }
            if (state.includeNumbers) {
              charPool += CHARSETS.numbers;
              password.push(
                CHARSETS.numbers[
                  Math.floor(Math.random() * CHARSETS.numbers.length)
                ],
              );
            }
            if (state.includeSymbols) {
              charPool += CHARSETS.symbols;
              password.push(
                CHARSETS.symbols[
                  Math.floor(Math.random() * CHARSETS.symbols.length)
                ],
              );
            }

            if (
              !state.includeUpper &&
              !state.includeNumbers &&
              !state.includeSymbols &&
              password.length > state.length
            ) {
              password = password.slice(0, state.length);
            }

            const remainingLen = state.length - password.length;
            for (let i = 0; i < remainingLen; i++) {
              password.push(
                charPool[Math.floor(Math.random() * charPool.length)],
              );
            }

            for (let i = password.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [password[i], password[j]] = [password[j], password[i]];
            }

            const finalPassword = password.join("");
            passOutput.textContent = finalPassword;
            passOutput.classList.remove("empty");
          };

          lengthSlider.addEventListener("input", (e) => {
            state.length = parseInt(e.target.value, 10);
            lengthVal.textContent = state.length;
            ctx.persist("length", state.length);
          });
          upperCheck.addEventListener("change", (e) => {
            state.includeUpper = e.target.checked;
            ctx.persist("includeUpper", state.includeUpper);
          });
          numCheck.addEventListener("change", (e) => {
            state.includeNumbers = e.target.checked;
            ctx.persist("includeNumbers", state.includeNumbers);
          });
          symCheck.addEventListener("change", (e) => {
            state.includeSymbols = e.target.checked;
            ctx.persist("includeSymbols", state.includeSymbols);
          });
          generateBtn.addEventListener("click", generatePassword);
          copyBtn.addEventListener("click", () => {
            const text = passOutput.textContent;
            if (passOutput.classList.contains("empty")) return;
            navigator.clipboard
              .writeText(text)
              .then(() => {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = "Copied!";
                setTimeout(() => (copyBtn.textContent = originalText), 1500);
              })
              .catch((err) => {
                alert("Failed to copy password.");
              });
          });
        },
      });

      // Code Snippet Manager
      registerFeature({
        id: "snippets",
        name: "Code Snippets",
        icon: "‚ö°",
        keywords: ["code", "snippets", "developer", "syntax", "programming"],
        mount(ctx) {
          const state = ctx.state;
          state.snippets = state.snippets || [];

          const container = document.createElement("div");
          container.className = "snippets-container";

          // Create header with search and add button
          const header = document.createElement("div");
          header.className = "snippets-header";
          header.innerHTML = `
      <input type="text" id="snippetSearch" class="search snippets-search" placeholder="Search snippets...">
      <button id="addSnippetBtn">+ Add Snippet</button>
    `;

          // Create snippets grid
          const grid = document.createElement("div");
          grid.className = "snippets-grid";
          grid.id = "snippetsGrid";

          container.appendChild(header);
          container.appendChild(grid);
          ctx.elBody.appendChild(container);

          const $id = (id) => container.querySelector(`#${id}`);
          const searchInput = $id("snippetSearch");
          const addBtn = $id("addSnippetBtn");
          const snippetsGrid = $id("snippetsGrid");

          let editingId = null;

          // Language to color mapping for syntax highlighting simulation
          const LANG_COLORS = {
            javascript: "#f7df1e",
            python: "#306998",
            html: "#e34c26",
            css: "#1572b6",
            java: "#007396",
            cpp: "#00599c",
            rust: "#000000",
            go: "#00add8",
            php: "#777bb4",
            ruby: "#cc342d",
            sql: "#336791",
            bash: "#4eaa25",
            json: "#000000",
            xml: "#0060ac",
            typescript: "#007acc",
            other: "#6c757d",
          };

          const getLanguageColor = (lang) =>
            LANG_COLORS[lang.toLowerCase()] || LANG_COLORS.other;

          const renderSnippets = (filter = "") => {
            const filtered = state.snippets.filter(
              (snippet) =>
                snippet.title.toLowerCase().includes(filter.toLowerCase()) ||
                snippet.language.toLowerCase().includes(filter.toLowerCase()) ||
                snippet.code.toLowerCase().includes(filter.toLowerCase()),
            );

            if (filtered.length === 0) {
              snippetsGrid.innerHTML = `
          <div class="snippet-empty">
            ${filter ? "No snippets match your search." : "No snippets yet. Add your first one!"}
          </div>
        `;
              return;
            }

            snippetsGrid.innerHTML = "";

            filtered.forEach((snippet) => {
              const card = document.createElement("div");
              card.className = "snippet-card";

              const langColor = getLanguageColor(snippet.language);

              card.innerHTML = `
          <div class="snippet-header">
            <div class="snippet-title">${snippet.title}</div>
            <div class="snippet-lang" style="background-color: ${langColor}20; color: ${langColor}">
              ${snippet.language}
            </div>
            <div class="snippet-actions">
              <button onclick="copySnippet('${snippet.id}')">üìã</button>
              <button onclick="editSnippet('${snippet.id}')">‚úèÔ∏è</button>
              <button onclick="deleteSnippet('${snippet.id}')" style="color: var(--danger)">üóëÔ∏è</button>
            </div>
          </div>
          <div class="snippet-code">${escapeHtml(snippet.code)}</div>
        `;

              snippetsGrid.appendChild(card);
            });
          };

          const escapeHtml = (text) => {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
          };

          const showForm = (snippet = null) => {
            const isEdit = !!snippet;
            editingId = isEdit ? snippet.id : null;

            const form = document.createElement("div");
            form.className = "snippet-form";
            form.innerHTML = `
        <div class="snippet-form-row">
          <input type="text" id="snippetTitle" placeholder="Snippet title..." value="${isEdit ? snippet.title : ""}" />
          <select id="snippetLang">
            <option value="javascript" ${isEdit && snippet.language === "javascript" ? "selected" : ""}>JavaScript</option>
            <option value="python" ${isEdit && snippet.language === "python" ? "selected" : ""}>Python</option>
            <option value="html" ${isEdit && snippet.language === "html" ? "selected" : ""}>HTML</option>
            <option value="css" ${isEdit && snippet.language === "css" ? "selected" : ""}>CSS</option>
            <option value="java" ${isEdit && snippet.language === "java" ? "selected" : ""}>Java</option>
            <option value="cpp" ${isEdit && snippet.language === "cpp" ? "selected" : ""}>C++</option>
            <option value="rust" ${isEdit && snippet.language === "rust" ? "selected" : ""}>Rust</option>
            <option value="go" ${isEdit && snippet.language === "go" ? "selected" : ""}>Go</option>
            <option value="php" ${isEdit && snippet.language === "php" ? "selected" : ""}>PHP</option>
            <option value="ruby" ${isEdit && snippet.language === "ruby" ? "selected" : ""}>Ruby</option>
            <option value="sql" ${isEdit && snippet.language === "sql" ? "selected" : ""}>SQL</option>
            <option value="bash" ${isEdit && snippet.language === "bash" ? "selected" : ""}>Bash</option>
            <option value="json" ${isEdit && snippet.language === "json" ? "selected" : ""}>JSON</option>
            <option value="xml" ${isEdit && snippet.language === "xml" ? "selected" : ""}>XML</option>
            <option value="typescript" ${isEdit && snippet.language === "typescript" ? "selected" : ""}>TypeScript</option>
            <option value="other" ${isEdit && snippet.language === "other" ? "selected" : ""}>Other</option>
          </select>
        </div>
        <textarea id="snippetCode" placeholder="Paste your code here...">${isEdit ? snippet.code : ""}</textarea>
        <div class="snippet-form-actions">
          <button id="cancelBtn">Cancel</button>
          <button id="saveBtn">${isEdit ? "Update" : "Save"} Snippet</button>
        </div>
      `;

            // Insert form at the top
            container.insertBefore(form, grid);

            const titleInput = form.querySelector("#snippetTitle");
            const langSelect = form.querySelector("#snippetLang");
            const codeTextarea = form.querySelector("#snippetCode");
            const cancelBtn = form.querySelector("#cancelBtn");
            const saveBtn = form.querySelector("#saveBtn");

            titleInput.focus();

            cancelBtn.onclick = () => {
              form.remove();
              editingId = null;
            };

            saveBtn.onclick = () => {
              const title = titleInput.value.trim();
              const language = langSelect.value;
              const code = codeTextarea.value.trim();

              if (!title || !code) {
                alert("Please fill in title and code");
                return;
              }

              if (isEdit) {
                const index = state.snippets.findIndex(
                  (s) => s.id === editingId,
                );
                if (index !== -1) {
                  state.snippets[index] = {
                    ...state.snippets[index],
                    title,
                    language,
                    code,
                  };
                }
              } else {
                const newSnippet = {
                  id: uid("snippet"),
                  title,
                  language,
                  code,
                  created: new Date().toISOString(),
                };
                state.snippets.unshift(newSnippet);
              }

              ctx.setState({ snippets: state.snippets });
              form.remove();
              editingId = null;
              renderSnippets(searchInput.value);
            };
          };

          // Global functions for snippet actions
          window.copySnippet = (id) => {
            const snippet = state.snippets.find((s) => s.id === id);
            if (snippet) {
              navigator.clipboard
                .writeText(snippet.code)
                .then(() => {
                  // Show temporary feedback
                  const card = document.querySelector(
                    `[onclick="copySnippet('${id}')"]`,
                  );
                  if (card) {
                    const originalText = card.textContent;
                    card.textContent = "‚úì";
                    setTimeout(() => (card.textContent = originalText), 1000);
                  }
                })
                .catch(() => alert("Failed to copy snippet"));
            }
          };

          window.editSnippet = (id) => {
            const snippet = state.snippets.find((s) => s.id === id);
            if (snippet) {
              showForm(snippet);
            }
          };

          window.deleteSnippet = (id) => {
            const snippet = state.snippets.find((s) => s.id === id);
            if (snippet && confirm(`Delete "${snippet.title}"?`)) {
              state.snippets = state.snippets.filter((s) => s.id !== id);
              ctx.setState({ snippets: state.snippets });
              renderSnippets(searchInput.value);
            }
          };

          // Event listeners
          addBtn.onclick = () => showForm();

          searchInput.addEventListener("input", (e) => {
            renderSnippets(e.target.value);
          });

          // Initial render
          renderSnippets();
        },
      });

      // Pomodoro Timer Feature
      registerFeature({
        id: "pomodoro",
        name: "Pomodoro Timer",
        icon: "üçÖ",
        keywords: [
          "timer",
          "productivity",
          "focus",
          "work",
          "break",
          "pomodoro",
        ],
        mount(ctx) {
          const DEFAULT_SETTINGS = {
            workMinutes: 25,
            shortBreakMinutes: 5,
            longBreakMinutes: 15,
            sessionsUntilLongBreak: 4,
            soundEnabled: true,
            autoStartBreaks: false,
            autoStartWork: false,
          };

          const state = {
            settings: { ...DEFAULT_SETTINGS, ...(ctx.state.settings || {}) },
            currentPhase: ctx.state.currentPhase || "work", // 'work', 'shortBreak', 'longBreak'
            timeRemaining: ctx.state.timeRemaining || null,
            isRunning: false,
            sessionCount: ctx.state.sessionCount || 0,
            totalWorkTime: ctx.state.totalWorkTime || 0,
            todayStats: ctx.state.todayStats || {
              sessions: 0,
              workMinutes: 0,
              date: new Date().toDateString(),
            },

            history: ctx.state.history || [],
            currentTask: ctx.state.currentTask || "",
          };

          // Reset today's stats if it's a new day
          const today = new Date().toDateString();
          if (state.todayStats.date !== today) {
            state.todayStats = { sessions: 0, workMinutes: 0, date: today };
            ctx.persist("todayStats", state.todayStats);
          }

          let timerInterval = null;
          let startTime = null;

          const container = document.createElement("div");
          container.className = "pomodoro-container";

          // Create timer display
          const timerSection = document.createElement("div");
          timerSection.innerHTML = `
      <div class="pomodoro-timer-circle">
        <svg class="pomodoro-timer-svg">
          <circle class="pomodoro-timer-bg" cx="140" cy="140" r="130"></circle>
          <circle class="pomodoro-timer-progress ${state.currentPhase !== "work" ? "break" : ""}" 
                  cx="140" cy="140" r="130" 
                  stroke-dasharray="816.8" 
                  stroke-dashoffset="816.8"></circle>
        </svg>
        <div class="pomodoro-timer-display">
          <div class="pomodoro-time">25:00</div>
          <div class="pomodoro-phase">Ready to Focus</div>
        </div>
      </div>
    `;

          // Task input
          const taskSection = document.createElement("div");
          taskSection.innerHTML = `
      <input type="text" class="pomodoro-task-input" 
             placeholder="What are you working on?" 
             value="${state.currentTask}">
    `;

          // Controls
          const controlsSection = document.createElement("div");
          controlsSection.className = "pomodoro-controls";
          controlsSection.innerHTML = `
      <button id="startBtn" class="pomodoro-btn-primary">Start Focus</button>
      <button id="pauseBtn" style="display:none">Pause</button>
      <button id="resetBtn">Reset</button>
      <button id="skipBtn">Skip</button>
    `;

          // Stats
          const statsSection = document.createElement("div");
          statsSection.className = "pomodoro-stats";
          statsSection.innerHTML = `
      <div class="pomodoro-stat">
        <div class="pomodoro-stat-value">${state.todayStats.sessions}</div>
        <div class="pomodoro-stat-label">Today's Sessions</div>
      </div>
      <div class="pomodoro-stat">
        <div class="pomodoro-stat-value">${Math.floor(state.todayStats.workMinutes)}</div>
        <div class="pomodoro-stat-label">Minutes Focused</div>
      </div>
      <div class="pomodoro-stat">
        <div class="pomodoro-stat-value">${state.sessionCount % state.settings.sessionsUntilLongBreak}</div>
        <div class="pomodoro-stat-label">Until Long Break</div>
      </div>
      <div class="pomodoro-stat">
        <div class="pomodoro-stat-value">${Math.floor(state.totalWorkTime / 60)}</div>
        <div class="pomodoro-stat-label">Total Hours</div>
      </div>
    `;

          // Settings
          const settingsSection = document.createElement("div");
          settingsSection.className = "pomodoro-settings";
          settingsSection.innerHTML = `
      <h4>Timer Settings</h4>
      <div class="pomodoro-setting-row">
        <span class="pomodoro-setting-label">Focus Time</span>
        <input type="range" id="workSlider" min="1" max="60" value="${state.settings.workMinutes}">
        <span class="pomodoro-setting-value">${state.settings.workMinutes}m</span>
      </div>
      <div class="pomodoro-setting-row">
        <span class="pomodoro-setting-label">Short Break</span>
        <input type="range" id="shortBreakSlider" min="1" max="30" value="${state.settings.shortBreakMinutes}">
        <span class="pomodoro-setting-value">${state.settings.shortBreakMinutes}m</span>
      </div>
      <div class="pomodoro-setting-row">
        <span class="pomodoro-setting-label">Long Break</span>
        <input type="range" id="longBreakSlider" min="5" max="60" value="${state.settings.longBreakMinutes}">
        <span class="pomodoro-setting-value">${state.settings.longBreakMinutes}m</span>
      </div>
      <div style="display:flex; gap:16px; margin-top:12px;">
        <label><input type="checkbox" id="soundCheck" ${state.settings.soundEnabled ? "checked" : ""}> Sound Alerts</label>
        <label><input type="checkbox" id="autoBreakCheck" ${state.settings.autoStartBreaks ? "checked" : ""}> Auto-start Breaks</label>
        <label><input type="checkbox" id="autoWorkCheck" ${state.settings.autoStartWork ? "checked" : ""}> Auto-start Work</label>
      </div>
    `;

          // History
          const historySection = document.createElement("div");
          const renderHistory = () => {
            const recentHistory = state.history.slice(-5).reverse();
            historySection.innerHTML = `
        <h4>Recent Sessions</h4>
        <div class="pomodoro-history">
          ${
            recentHistory.length === 0
              ? '<div class="muted">No sessions yet</div>'
              : recentHistory
                  .map(
                    (item) => `
              <div class="pomodoro-history-item">
                <div>
                  <div class="pomodoro-history-task">${item.task || "Untitled Session"}</div>
                  <div class="pomodoro-history-time">${new Date(item.timestamp).toLocaleString()}</div>
                </div>
                <div>${item.duration}m</div>
              </div>
            `,
                  )
                  .join("")
          }
        </div>
      `;
          };
          renderHistory();

          // Append all sections
          container.appendChild(timerSection);
          container.appendChild(taskSection);
          container.appendChild(controlsSection);
          container.appendChild(statsSection);
          container.appendChild(settingsSection);
          container.appendChild(historySection);
          ctx.elBody.appendChild(container);

          // Get elements
          const $id = (id) => container.querySelector(`#${id}`);
          const timeDisplay = container.querySelector(".pomodoro-time");
          const phaseDisplay = container.querySelector(".pomodoro-phase");
          const progressCircle = container.querySelector(
            ".pomodoro-timer-progress",
          );
          const taskInput = container.querySelector(".pomodoro-task-input");
          const startBtn = $id("startBtn");
          const pauseBtn = $id("pauseBtn");
          const resetBtn = $id("resetBtn");
          const skipBtn = $id("skipBtn");

          // Initialize time if needed
          if (state.timeRemaining === null) {
            state.timeRemaining = state.settings.workMinutes * 60;
          }

          // Sound functions
          const playSound = (frequency = 520, duration = 200) => {
            if (!state.settings.soundEnabled) return;
            const audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = "sine";

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioContext.currentTime + duration / 1000,
            );

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
          };

          const playCompletionSound = () => {
            playSound(523, 150);
            setTimeout(() => playSound(659, 150), 150);
            setTimeout(() => playSound(784, 300), 300);
          };

          // Timer functions
          const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
          };

          const updateDisplay = () => {
            timeDisplay.textContent = formatTime(state.timeRemaining);

            const phaseTexts = {
              work: "Focus Time",
              shortBreak: "Short Break",
              longBreak: "Long Break",
            };
            phaseDisplay.textContent = state.isRunning
              ? phaseTexts[state.currentPhase]
              : state.currentPhase === "work"
                ? "Ready to Focus"
                : "Ready for Break";

            // Update progress circle
            const totalTime =
              state.currentPhase === "work"
                ? state.settings.workMinutes * 60
                : state.currentPhase === "shortBreak"
                  ? state.settings.shortBreakMinutes * 60
                  : state.settings.longBreakMinutes * 60;
            const progress = (totalTime - state.timeRemaining) / totalTime;
            const offset = 816.8 * (1 - progress);
            progressCircle.style.strokeDashoffset = offset;

            // Update button states
            if (state.currentPhase !== "work") {
              progressCircle.classList.add("break");
              startBtn.classList.add("break");
              startBtn.textContent = state.isRunning
                ? "Pause Break"
                : "Start Break";
            } else {
              progressCircle.classList.remove("break");
              startBtn.classList.remove("break");
              startBtn.textContent = state.isRunning ? "Pause" : "Start Focus";
            }
          };

          const completeSession = () => {
            playCompletionSound();

            // Show notification
            const notification = document.createElement("div");
            notification.className = "pomodoro-notification";
            notification.textContent =
              state.currentPhase === "work"
                ? "üéâ Focus session complete!"
                : "‚úÖ Break finished!";
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);

            if (state.currentPhase === "work") {
              // Update stats
              const duration = Math.floor(state.settings.workMinutes);
              state.sessionCount++;
              state.totalWorkTime += duration;
              state.todayStats.sessions++;
              state.todayStats.workMinutes += duration;

              // Add to history
              state.history.push({
                task: state.currentTask || "Untitled Session",
                duration: duration,
                timestamp: new Date().toISOString(),
              });
              if (state.history.length > 50)
                state.history = state.history.slice(-50);

              // Persist stats
              ctx.persist("sessionCount", state.sessionCount);
              ctx.persist("totalWorkTime", state.totalWorkTime);
              ctx.persist("todayStats", state.todayStats);
              ctx.persist("history", state.history);

              // Update displays
              renderHistory();
              statsSection.querySelector(
                ".pomodoro-stat:nth-child(1) .pomodoro-stat-value",
              ).textContent = state.todayStats.sessions;
              statsSection.querySelector(
                ".pomodoro-stat:nth-child(2) .pomodoro-stat-value",
              ).textContent = Math.floor(state.todayStats.workMinutes);
              statsSection.querySelector(
                ".pomodoro-stat:nth-child(3) .pomodoro-stat-value",
              ).textContent =
                state.sessionCount % state.settings.sessionsUntilLongBreak;
              statsSection.querySelector(
                ".pomodoro-stat:nth-child(4) .pomodoro-stat-value",
              ).textContent = Math.floor(state.totalWorkTime / 60);

              // Determine next phase
              if (
                state.sessionCount % state.settings.sessionsUntilLongBreak ===
                0
              ) {
                state.currentPhase = "longBreak";
                state.timeRemaining = state.settings.longBreakMinutes * 60;
              } else {
                state.currentPhase = "shortBreak";
                state.timeRemaining = state.settings.shortBreakMinutes * 60;
              }

              if (state.settings.autoStartBreaks) {
                startTimer();
              }
            } else {
              // Break completed
              state.currentPhase = "work";
              state.timeRemaining = state.settings.workMinutes * 60;

              if (state.settings.autoStartWork) {
                startTimer();
              }
            }

            ctx.persist("currentPhase", state.currentPhase);
            updateDisplay();
          };

          const tick = () => {
            state.timeRemaining--;
            ctx.persist("timeRemaining", state.timeRemaining);

            if (state.timeRemaining <= 0) {
              stopTimer();
              completeSession();
            } else {
              updateDisplay();
            }
          };

          const startTimer = () => {
            state.isRunning = true;
            startTime = Date.now();
            timerInterval = setInterval(tick, 1000);
            startBtn.style.display = "none";
            pauseBtn.style.display = "inline-block";
            updateDisplay();
          };

          const stopTimer = () => {
            state.isRunning = false;
            if (timerInterval) {
              clearInterval(timerInterval);
              timerInterval = null;
            }
            pauseBtn.style.display = "none";
            startBtn.style.display = "inline-block";
            updateDisplay();
          };

          const resetTimer = () => {
            stopTimer();
            state.timeRemaining =
              state.currentPhase === "work"
                ? state.settings.workMinutes * 60
                : state.currentPhase === "shortBreak"
                  ? state.settings.shortBreakMinutes * 60
                  : state.settings.longBreakMinutes * 60;
            ctx.persist("timeRemaining", state.timeRemaining);
            updateDisplay();
          };

          const skipPhase = () => {
            stopTimer();
            if (state.currentPhase === "work") {
              if (
                state.sessionCount % state.settings.sessionsUntilLongBreak ===
                0
              ) {
                state.currentPhase = "longBreak";
                state.timeRemaining = state.settings.longBreakMinutes * 60;
              } else {
                state.currentPhase = "shortBreak";
                state.timeRemaining = state.settings.shortBreakMinutes * 60;
              }
            } else {
              state.currentPhase = "work";
              state.timeRemaining = state.settings.workMinutes * 60;
            }
            ctx.persist("currentPhase", state.currentPhase);
            ctx.persist("timeRemaining", state.timeRemaining);
            updateDisplay();
          };

          // Event listeners
          startBtn.onclick = startTimer;
          pauseBtn.onclick = stopTimer;
          resetBtn.onclick = resetTimer;
          skipBtn.onclick = skipPhase;

          taskInput.addEventListener("input", (e) => {
            state.currentTask = e.target.value;
            ctx.persist("currentTask", state.currentTask);
          });

          // Settings listeners
          ["work", "shortBreak", "longBreak"].forEach((phase) => {
            const slider = $id(`${phase === "work" ? "work" : phase}Slider`);
            const key = `${phase === "work" ? "work" : phase}Minutes`;

            slider.addEventListener("input", (e) => {
              const value = parseInt(e.target.value);
              state.settings[key] = value;
              slider.nextElementSibling.textContent = `${value}m`;
              ctx.persist("settings", state.settings);

              // Update current time if this is the active phase and timer is not running
              if (!state.isRunning) {
                if (
                  (phase === "work" && state.currentPhase === "work") ||
                  (phase === "shortBreak" &&
                    state.currentPhase === "shortBreak") ||
                  (phase === "longBreak" && state.currentPhase === "longBreak")
                ) {
                  state.timeRemaining = value * 60;
                  ctx.persist("timeRemaining", state.timeRemaining);
                  updateDisplay();
                }
              }
            });
          });

          $id("soundCheck").addEventListener("change", (e) => {
            state.settings.soundEnabled = e.target.checked;
            ctx.persist("settings", state.settings);
          });

          $id("autoBreakCheck").addEventListener("change", (e) => {
            state.settings.autoStartBreaks = e.target.checked;
            ctx.persist("settings", state.settings);
          });

          $id("autoWorkCheck").addEventListener("change", (e) => {
            state.settings.autoStartWork = e.target.checked;
            ctx.persist("settings", state.settings);
          });

          // Initial display update
          updateDisplay();

          // Cleanup on unmount
          ctx.bus.on("state:changed", () => {
            if (currentRoute()[0] !== "pomodoro" && timerInterval) {
              clearInterval(timerInterval);
            }
          });
        },
      });

      // initial render
      renderNav();
      if (!location.hash) go("scratchpad");
      else renderRoute();
    </script>
  </body>
</html>
